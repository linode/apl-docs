<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Otomi RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Otomi Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KKV4ZVDEKQ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KKV4ZVDEKQ",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Otomi" href="/opensearch.xml"><title data-rh="true">Our development journey | Otomi</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://otomi.io/img/otomi-logo.svg"><meta data-rh="true" name="twitter:image" content="https://otomi.io/img/otomi-logo.svg"><meta data-rh="true" property="og:url" content="https://otomi.io/about/journey"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-about-current"><meta data-rh="true" property="og:title" content="Our development journey | Otomi"><meta data-rh="true" name="description" content="Kubernetes offers a cli to send manifests over the wire for clusters to accept or reject. From a developers perspective, it offers nothing to build or help structuring these manifests. So what do you use to manage your manifests?"><meta data-rh="true" property="og:description" content="Kubernetes offers a cli to send manifests over the wire for clusters to accept or reject. From a developers perspective, it offers nothing to build or help structuring these manifests. So what do you use to manage your manifests?"><link data-rh="true" rel="icon" href="/img/otomi.ico"><link data-rh="true" rel="canonical" href="https://otomi.io/about/journey"><link data-rh="true" rel="alternate" href="https://otomi.io/about/journey" hreflang="en"><link data-rh="true" rel="alternate" href="https://otomi.io/about/journey" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://U3MTGFO19C-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.6ac5fa5d.css">
<link rel="preload" href="/assets/js/runtime~main.70749d45.js" as="script">
<link rel="preload" href="/assets/js/main.1cfce2e8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" style="background-color:#0d47a1;color:#ffd700" role="banner"><div class="announcementBarPlaceholder_NC_W"></div><div class="announcementBarContent_KsVm">If you like Otomi, give it a ‚≠êÔ∏è on <a target="_blank" rel="noopener noreferrer" href="https://github.com/redkubes/otomi-core">GitHub</a>!</div><button type="button" class="clean-btn close announcementBarClose_FG1z" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/otomi-logo.svg" alt="Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/otomi-logo.svg" alt="Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/about/">About</a><a class="navbar__item navbar__link" href="/docs/installation/">Docs</a><a class="navbar__item navbar__link" href="/docs/faq">FAQ</a><a class="navbar__item navbar__link" href="/community/get-involved">Community</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/redkubes/otomi-core" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">üåú</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">üåû</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode (currently light mode)"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO menuWithAnnouncementBar_x19h"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/about/">About</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/vision">Vision</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/about/journey">Journey</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/about/roadmap">Roadmap</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/">üè†</a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">About</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/about/journey">Journey</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Our development journey</h1></header><p>Kubernetes offers a cli to send manifests over the wire for clusters to accept or reject. From a developers perspective, it offers nothing to build or help structuring these manifests. So what do you use to manage your manifests?</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="helm">Helm<a class="hash-link" href="#helm" title="Direct link to heading">‚Äã</a></h3><p>After having worked with helm charts for a long time this seemed like a natural fit for a k8s package manager. We also saw that we wanted to consolidate the charts into our own repo, offering control, predictability and enabling offline installs.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="helmfile">Helmfile<a class="hash-link" href="#helmfile" title="Direct link to heading">‚Äã</a></h3><p>However, we quickly realized we needed a solution to provide variations of the chart values. When you have multiple clusters for different purposes, differences in environment (i.e. dev vs prod) become a differentiating factor. After reviewing the solutions at the time (jsonnet, helmfile) we decided to stay with Go templating and go for <a href="https://github.com/roboll/helmfile" target="_blank" rel="noopener noreferrer">Helmfile</a>. This offered us all the flexibility to achieve what we want: describing stateful configuration while abstracting away the input. Looking back we are glad to have made this choice, and still believe nothing else comes this close to meet our needs. (Only recently was a small helper tool added to k8s core: kustomize. This is however just a small utility, and it does not offer templating.)</p><p>After having worked with Helmfile however, we discovered that it offered no real best practices when it comes to coding and management, and might be too flexible to come up with a decent architecture. Some setups in the wild had some degree of sanity, but none offered the developers experience we really wanted. After many evolutions organizing our helmfile architecture we settled on something that we are still very happy with. It uses Helmfile&#x27;s alphabetic ordering and reminds of a Unix runlevel.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="layered-yaml-configuration">Layered yaml configuration<a class="hash-link" href="#layered-yaml-configuration" title="Direct link to heading">‚Äã</a></h3><p>When modeling configuration for different clusters you come to understand what is shared, and what is unique per cluster. Knowing that helmfile is designed to merge layered yaml files, we settled for a file structure that resembles this understanding. From generic to specific, this made the configuration as <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="noopener noreferrer">DRY</a> as we could, limiting human error.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="values-repo">Values repo<a class="hash-link" href="#values-repo" title="Direct link to heading">‚Äã</a></h3><p>In the beginning we used our monorepo as is, and kept all the configuration in there as well. But why not make the monorepo stateless itself? And extract the fast moving values to an external storage solution? That offered us the possibility to package up the entire monorepo in a container, and version it. This not only resulted in a clean simple setup in the monorepo with only Go templating, but now we have an external repo with yaml configuration that is extremely suitable for GitOps.</p><p>From a developers perspective, having made this seperation of concerns made a lot of sense. Only values exist in the repo, so auditing the trail of changes becomes easy. Just look at the commit diff. The core is now essentially a product (albeit one of many parts with lots of glue) that can evolve over time.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="gitops-with-drone">GitOps with Drone<a class="hash-link" href="#gitops-with-drone" title="Direct link to heading">‚Äã</a></h3><p>After having automated the delivery of our monorepo as a docker image, we could finally automate GitOps deployment. However, after having worked with Weave Flux extensively, we came to see that most of these GitOps solutions are an overkill to what we need, and do not support our DRY way of working. Most of the GitOps solutions out there make you use custom resources to tell you what to sync and what not, making you build and maintain a lot of glue to do what should be very easy. We just want to apply changing values using versioned artifacts. We don&#x27;t want to keep code in sync, just configuration.</p><p>So we decided to keep it simple (stupid) and use good old Drone, which is triggered by git webhook to just do what we, as developers do: deploy the changed motherload to the cluster that is interested in receiving those changes. We did not have to deviate from the developers workflow, and could even model it the same way, using the same tooling.</p><p>One thing that we don&#x27;t like about it: it is webhook based (push), and does not retry when the hook is not working. We will soon have a solution that allows for periodic syncing.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="single-sign-on-with-keycloak">Single Sign On with Keycloak<a class="hash-link" href="#single-sign-on-with-keycloak" title="Direct link to heading">‚Äã</a></h3><p>We were using <a href="https://github.com/oauth2-proxy/oauth2-proxy" target="_blank" rel="noopener noreferrer">oauth2-proxy</a> from the beginning, and were able to use it for SSO just fine, for a while. We had enabled a lot of OIDC aware applications when we started seeing the beauty of normalizing an OIDC JWT&#x27;s payload. This would allow applications to just consume the provided JWT without having to run a client to talk to the IDP. That is how we chose to put <a href="https://www.keycloak.org" target="_blank" rel="noopener noreferrer">Keycloak</a> in between oauth2-proxy and external IDPs, because it is very good at that. It has lots of knobs and settings to talk to exotic IDPs and translate incoming properties and claims.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="running-tasks">Running tasks<a class="hash-link" href="#running-tasks" title="Direct link to heading">‚Äã</a></h3><p>Since we are effectively configuring open source applications, we needed a way to run <a href="https://github.com/redkubes/otomi-tasks/" target="_blank" rel="noopener noreferrer">tasks</a> at the right moments in the deployment lifecycle. Example: Keycloak needs to be told how applications can reach it, before any of the crucial ones actually do. Istio won&#x27;t forward a request when it is told to authenticate but can&#x27;t reach Keycloak.</p><p>To be able to easily generate openapi typescript clients for tasks to talk to the applications, we have also created a small repo named <a href="https://github.com/redkubes/otomi-clients/" target="_blank" rel="noopener noreferrer">otomi-clients</a>. We were already using typescript for our NodeJS API and Console UI, so this was an easy choice for us.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="test-and-validate-everything">Test and validate everything<a class="hash-link" href="#test-and-validate-everything" title="Direct link to heading">‚Äã</a></h3><p>After unknowingly delivering breaking changes too many times, we went all the way and decided to validate all input and output as best as we can.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="input-checks"><strong>Input checks</strong><a class="hash-link" href="#input-checks" title="Direct link to heading">‚Äã</a></h4><p>We introduced a jsonschema validation routine that can be used statically by your editor (in VSCode this works out of the box), but is also used pre-commit to avoid broken configuration.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="output-checks"><strong>Output checks</strong><a class="hash-link" href="#output-checks" title="Direct link to heading">‚Äã</a></h4><p>After having settled for <a href="https://www.openpolicyagent.org" target="_blank" rel="noopener noreferrer">OPA</a> as our policy management solution, we came up with an elaborate approach to have Universal OPA Policies (akin to Universal Javascript). We crafted a mix of <a href="https://www.conftest.dev" target="_blank" rel="noopener noreferrer">Conftest</a> and custom CRD/CR extraction routines to check if all the manifests are adhering to k8s best practices and the OPA policies we settled for. This allows not only for static validation, but also for OPA gatekeeper to uphold these same policies on the cluster.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="smooth-sailing">Smooth sailing<a class="hash-link" href="#smooth-sailing" title="Direct link to heading">‚Äã</a></h2><p>Having built a very flexible and easily approachable development platform for kubernetes solutions, we can truly say we are now smooth sailing. We just keep building out the functionality in the core, and expose more and more configuration for values to manipulate.</p><p>Of course there are sometimes unforeseen waves rocking our boat, and we try to be ready for when they come. We invite you to look at our <a href="/about/roadmap">roadmap</a> to see potential problems we have identified so far, but also the opportunities waiting to land.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/redkubes/redkubes.github.io/edit/master/about/about-journey.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2021-11-23T16:03:20.000Z">11/23/2021</time></b> by <b>Maurice Faber</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/about/vision"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Vision</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/about/architecture"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Architecture</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#helm" class="table-of-contents__link toc-highlight">Helm</a></li><li><a href="#helmfile" class="table-of-contents__link toc-highlight">Helmfile</a></li><li><a href="#layered-yaml-configuration" class="table-of-contents__link toc-highlight">Layered yaml configuration</a></li><li><a href="#values-repo" class="table-of-contents__link toc-highlight">Values repo</a></li><li><a href="#gitops-with-drone" class="table-of-contents__link toc-highlight">GitOps with Drone</a></li><li><a href="#single-sign-on-with-keycloak" class="table-of-contents__link toc-highlight">Single Sign On with Keycloak</a></li><li><a href="#running-tasks" class="table-of-contents__link toc-highlight">Running tasks</a></li><li><a href="#test-and-validate-everything" class="table-of-contents__link toc-highlight">Test and validate everything</a></li><li><a href="#smooth-sailing" class="table-of-contents__link toc-highlight">Smooth sailing</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Otomi</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/about/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/installation/">Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/console/">Using Otomi Console</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://otomi.slack.com/join/shared_invite/zt-12h11e8aa-6po4NWhhpMXxT~nffDsYqA#/shared-invite/email" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gitter.im/redkubes/community" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/community/get-involved">Community page</a></li></ul></div><div class="col footer__col"><div class="footer__title">Red Kubes</div><ul class="footer__items"><li class="footer__item"><a href="https://redkubes.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Website<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/redkubes/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/red-kubes/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/otomi-logo.svg" alt="Otomi Open Source Logo" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/img/otomi-logo.svg" alt="Otomi Open Source Logo" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></div><div class="footer__copyright">Copyright ¬© 2022 Red Kubes. Built with <a href="https://v2.docusaurus.io/">Docusaurus</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.70749d45.js"></script>
<script src="/assets/js/main.1cfce2e8.js"></script>
</body>
</html>