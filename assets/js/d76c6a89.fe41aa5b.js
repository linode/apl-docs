"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[4717],{7114:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var n=s(5893),t=s(1151);const a={slug:"harbor",title:"Harbor",sidebar_label:"Harbor"},i=void 0,o={id:"apps/harbor",title:"Harbor",description:"About",source:"@site/docs/apps/harbor.md",sourceDirName:"apps",slug:"/apps/harbor",permalink:"/docs/apps/harbor",draft:!1,unlisted:!1,editUrl:"https://github.com/linode/linode.github.io/tree/main/docs/apps/harbor.md",tags:[],version:"current",frontMatter:{slug:"harbor",title:"Harbor",sidebar_label:"Harbor"},sidebar:"mainSidebar",previous:{title:"Grafana",permalink:"/docs/apps/grafana"},next:{title:"Ingress-nginx",permalink:"/docs/apps/ingress-nginx"}},c={},l=[{value:"About",id:"about",level:2},{value:"Known issues",id:"known-issues",level:2},{value:"OIDC: conflicting user",id:"oidc-conflicting-user",level:3},{value:"Pod multi-attach error",id:"pod-multi-attach-error",level:3}];function d(e){const r={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.h2,{id:"about",children:"About"}),"\n",(0,n.jsxs)(r.p,{children:["Harbor is an open-source registry that secures artifacts with policies and role-based access control, ensures images are scanned and free from vulnerabilities, and signs images as trusted. Harbor delivers compliance, performance, and interoperability to help you consistently and securely manage artifacts across cloud-native compute platforms like Kubernetes. (source: ",(0,n.jsx)(r.a,{href:"https://goharbor.io/",children:"https://goharbor.io/"}),")"]}),"\n",(0,n.jsx)(r.p,{children:"The following Harbor maintenance tasks are automated:"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsx)(r.p,{children:"Creating a project in Harbor for each team."}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsx)(r.p,{children:"Creating a bot-account for each team."}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsx)(r.p,{children:"Creating a Kubernetes pull secret in the team namespace to enable pulling of images out of the local registry."}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsx)(r.p,{children:"Creating a Kubernetes push secret in the team namespace that can be downloaded (if enabled) by team members to push images to a private repo."}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["\n",(0,n.jsx)(r.p,{children:"Creating a Kubernetes push secret in the team namespace that is used by the Build self-service feature to push images to Harbor."}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(r.h2,{id:"known-issues",children:"Known issues"}),"\n",(0,n.jsx)(r.h3,{id:"oidc-conflicting-user",children:"OIDC: conflicting user"}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.strong,{children:"Problem:"})}),"\n",(0,n.jsxs)(r.p,{children:["Error while logging in to harbor with OIDC: ",(0,n.jsx)(r.code,{children:"Conflict, the user with same username or email has been onboarded."}),"."]}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.strong,{children:"Cause:"})}),"\n",(0,n.jsxs)(r.p,{children:["By redeploing keycloak the same user gets a new ",(0,n.jsx)(r.code,{children:"sub"})," claim in ",(0,n.jsx)(r.code,{children:"openid"})," scope. Harbor uses ",(0,n.jsx)(r.code,{children:"sub"})," and ",(0,n.jsx)(r.code,{children:"iss"})," claims in order to match them to a user from its database (see: ",(0,n.jsx)(r.code,{children:"subiss"})," column at ",(0,n.jsx)(r.code,{children:"oidc_user"})," table in ",(0,n.jsx)(r.code,{children:"registry"})," database). If the same user identifies with a new sub then harbor tries to create a new entry in the ",(0,n.jsx)(r.code,{children:"harbor_user"})," database table and it fails on the username column uniqueness constraint."]}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.strong,{children:"Solution:"})}),"\n",(0,n.jsxs)(r.p,{children:["Please check up on this link when this problem occurs, because a fix might already be released: ",(0,n.jsx)(r.a,{href:"https://github.com/goharbor/harbor/issues/13674",children:"goharbor/harbor#13674"}),". If so, please create a PR to fix this in the ",(0,n.jsx)(r.a,{href:"https://github.com/redkubes/otomi-core",children:"otomi-core"})," repo, or create an issue there. Otherwise continue:"]}),"\n",(0,n.jsx)(r.p,{children:"Connect to the database service"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"kh exec harbor-database-0 -it -- psql -U postgres\n"})}),"\n",(0,n.jsxs)(r.p,{children:["Select the ",(0,n.jsx)(r.code,{children:"registry"})," database"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sql",children:"\\c registry\n"})}),"\n",(0,n.jsxs)(r.p,{children:["Find out the ",(0,n.jsx)(r.code,{children:"<user_id>"})]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sql",children:"SELECT user_id FROM harbor_user WHERE username = '<user name>';\n"})}),"\n",(0,n.jsx)(r.p,{children:"Remove the user from the database"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sql",children:"DELETE FROM oidc_user WHERE user_id = <userid>;\nDELETE FROM harbor_user WHERE user_id = <userid>;\n"})}),"\n",(0,n.jsx)(r.p,{children:"Exit psql"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-sql",children:"\\q\n"})}),"\n",(0,n.jsx)(r.p,{children:"Try to login once again and observe that you are asked to confirm your username."}),"\n",(0,n.jsx)(r.h3,{id:"pod-multi-attach-error",children:"Pod multi-attach error"}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.strong,{children:"Problem"})}),"\n",(0,n.jsxs)(r.p,{children:["Kubernetes cannot schedule the ",(0,n.jsx)(r.code,{children:"harbor-harbor-registry"})," Pod."]}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.strong,{children:"Cause"})}),"\n",(0,n.jsx)(r.p,{children:"Multi-Attach error occurs for persistent volumes that support only one writer at a time."}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.strong,{children:"Solution"})}),"\n",(0,n.jsx)(r.p,{children:"Delete an existing harbor registry replicaset. Note that this operation makes registry temporarely unavailable."})]})}function h(e={}){const{wrapper:r}={...(0,t.a)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},1151:(e,r,s)=>{s.d(r,{Z:()=>o,a:()=>i});var n=s(7294);const t={},a=n.createContext(t);function i(e){const r=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),n.createElement(a.Provider,{value:r},e.children)}}}]);