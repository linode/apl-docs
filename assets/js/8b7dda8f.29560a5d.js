"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[4584],{8250:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var t=s(5893),r=s(1151);const i={slug:"custom-metrics",title:"Using custom metrics",sidebar_label:"Using custom metrics"},a=void 0,l={id:"get-started/labs/custom-metrics",title:"Using custom metrics",description:"For this lab Grafana and Alertmanager need to be enabled for the Team.",source:"@site/docs/get-started/labs/custom-metrics.md",sourceDirName:"get-started/labs",slug:"/get-started/labs/custom-metrics",permalink:"/docs/get-started/labs/custom-metrics",draft:!1,unlisted:!1,editUrl:"https://github.com/linode/linode.github.io/tree/main/docs/get-started/labs/custom-metrics.md",tags:[],version:"current",frontMatter:{slug:"custom-metrics",title:"Using custom metrics",sidebar_label:"Using custom metrics"},sidebar:"mainSidebar",previous:{title:"Monitor Services",permalink:"/docs/get-started/labs/monitor-services"},next:{title:"Create Network Policies",permalink:"/docs/get-started/labs/create-netpols"}},o={},c=[{value:"Create a Workload",id:"create-a-workload",level:2},{value:"Create a dashboard in Grafana to use the metrics",id:"create-a-dashboard-in-grafana-to-use-the-metrics",level:2},{value:"Make the dashboard persistent",id:"make-the-dashboard-persistent",level:2},{value:"Create custom rules",id:"create-custom-rules",level:2},{value:"See alerts based on the rule in Alertmanager",id:"see-alerts-based-on-the-rule-in-alertmanager",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsx)(n.p,{children:"For this lab Grafana and Alertmanager need to be enabled for the Team."})}),"\n",(0,t.jsx)(n.p,{children:"To be able to collect custom metrics you will first need to configure your app to expose metrics. This is called instrumentation of code and can include annotating the code with metadata, or adding in logic to calculate and expose data."}),"\n",(0,t.jsx)(n.p,{children:"Instrumenting code means you write code to expose information about the technical, business, and customer context. This information can then be collected and analyzed using Prometheus and Grafana."}),"\n",(0,t.jsx)(n.p,{children:"In this lab we'll use a container that exposes custom metrics and then show how the metrics can be collected and analysed."}),"\n",(0,t.jsx)(n.h2,{id:"create-a-workload",children:"Create a Workload"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Go to the Catalog and click on the ",(0,t.jsx)(n.code,{children:"k8s-deployment"})," template."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click on the ",(0,t.jsx)(n.code,{children:"Values"})," tab."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Fill in the name ",(0,t.jsx)(n.code,{children:"custom-metrics"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Use the following values:"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"image:\n  repository: quay.io/rbaumgar/monitor-demo-app-jvm\n  pullPolicy: IfNotPresent\n  tag: latest\ncontainerPorts:\n  - name: web\n    containerPort: 8080\n    protocol: TCP\nservicePorts:\n  - port: 8080\n    targetPort: 8080\n    protocol: TCP\n    name: web\nreplicaCount: 1\nserviceMonitor:\n  create: true\n  endpoints:\n    - interval: 30s\n      port: web\n      scheme: http\n      path: /q/metrics\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"5",children:["\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.code,{children:"Submit"})," and then ",(0,t.jsx)(n.code,{children:"Deploy Changes"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Our metrics will now be scraped by the Platform Prometheus. Before we continue, let's first generate some load:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Expose the ",(0,t.jsx)(n.code,{children:"custom-metrics"})," service (see lab ",(0,t.jsx)(n.a,{href:"/docs/get-started/labs/expose-services",children:"Expose services"}),")."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Run the following command in your terminal:"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"for i in {1..1000}; do curl https://custom-metrics-labs.<your-domain>/hello; sleep 10; done\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsx)(n.li,{children:"Wait for approximately 10 minutes..."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"create-a-dashboard-in-grafana-to-use-the-metrics",children:"Create a dashboard in Grafana to use the metrics"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In the left menu, click on ",(0,t.jsx)(n.code,{children:"Apps"})," and open ",(0,t.jsx)(n.code,{children:"Grafana"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Go to the Grafana dashboard homepage."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In the top right click on ",(0,t.jsx)(n.code,{children:"New"})," and then ",(0,t.jsx)(n.code,{children:"New Dashboard"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.code,{children:"+ Add visualization"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In the ",(0,t.jsx)(n.code,{children:"Query"})," tab select ",(0,t.jsx)(n.code,{children:"Prometheus Platform"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In the ",(0,t.jsx)(n.code,{children:"A"})," collapsible section, select a metric from the ",(0,t.jsx)(n.code,{children:"Metric"})," drop-down list. In our example we use the ",(0,t.jsx)(n.code,{children:"application_greetings_total"})," metric."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.code,{children:"Run queries"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["You should now see a ",(0,t.jsx)(n.code,{children:"Time series"})," graph like this:"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"dashboards",src:s(9695).Z+"",width:"3390",height:"2384"})}),"\n",(0,t.jsxs)(n.ol,{start:"9",children:["\n",(0,t.jsx)(n.li,{children:"Save the dashboard in Grafana."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"make-the-dashboard-persistent",children:"Make the dashboard persistent"}),"\n",(0,t.jsx)(n.p,{children:"Now you know how to create a dashboard in Grafana for your custom metrics. You could now save the dashboard, but if Grafana would get re-started, the dashboard will be gone. To make the dashboard persistent we need to add it to a configmap."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Go to ",(0,t.jsx)(n.code,{children:"apps"})," and open ",(0,t.jsx)(n.code,{children:"Gitea"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In the list of repositories there is a repository called ",(0,t.jsx)(n.code,{children:"otomi/team-<team-name>-argocd"}),". Go to this repository."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.code,{children:"Add File"})," and then ",(0,t.jsx)(n.code,{children:"New File"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Name the file ",(0,t.jsx)(n.code,{children:"my-custom-dashboard.yaml"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Add the following manifest to the file:"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: my-custom-dashboard\n  labels:\n    grafana_dashboard: "1"\n    release: grafana-dashboards-labs # change labs to the name of your team\ndata:\n  my-dashboard.json: |-\n    # paste your dashboard json here\n'})}),"\n",(0,t.jsxs)(n.ol,{start:"6",children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Before commiting changes, go back to Grafana."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click on ",(0,t.jsx)(n.code,{children:"Dashboard settings"})," (in the top right)."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In the left menu click ",(0,t.jsx)(n.code,{children:"JSON model"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Copy the JSON model and paste it into the ConfigMap. Make sure to indent with 4."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Delete the dashboard created in Grafana."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Commit changes in Gitea."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The dashboard will now automatically be loaded into the Team's Grafana instance."}),"\n",(0,t.jsx)(n.h2,{id:"create-custom-rules",children:"Create custom rules"}),"\n",(0,t.jsxs)(n.p,{children:["Now we are exporting metrics, these metrics can also be used to generate alerts. To generate alerts, we first need to create a Prometheus ",(0,t.jsx)(n.code,{children:"Rule"}),":"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Go to ",(0,t.jsx)(n.code,{children:"apps"})," and open ",(0,t.jsx)(n.code,{children:"Gitea"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In the list of repositories there is a repository called ",(0,t.jsx)(n.code,{children:"otomi/team-<team-name>-argocd"}),". Go to this repository."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.code,{children:"Add File"})," and then ",(0,t.jsx)(n.code,{children:"New File"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Name the file ",(0,t.jsx)(n.code,{children:"my-custom-rules.yaml"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Add the following manifest to the file:"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: system\n  name: labs-custom-rules\nspec:\n  groups:\n  - name: custom.rules\n    rules:\n    - alert: 50GreetingsReached\n      annotations:\n        description: We reached 50 greetings!\n        summary: The number of greetings has reached more than 50.\n      expr: application_greetings_total > 50\n      for: 1m\n      labels:\n        severity: warning\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"6",children:["\n",(0,t.jsx)(n.li,{children:"Commit changes in Gitea."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"see-alerts-based-on-the-rule-in-alertmanager",children:"See alerts based on the rule in Alertmanager"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Go to ",(0,t.jsx)(n.code,{children:"Apps"})," and open ",(0,t.jsx)(n.code,{children:"Alertmanager"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"You will see Alertmanager has received the alerts from Prometheus:"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"rules",src:s(8538).Z+"",width:"3156",height:"1498"})}),"\n",(0,t.jsx)(n.p,{children:"If a receiver has been configured for the Team, like Slack, then you would also have received a message with the alert."})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},9695:(e,n,s)=>{s.d(n,{Z:()=>t});const t=s.p+"assets/images/dashboards-1-66e45680891b7f44bd0ffb4d0c94ae74.png"},8538:(e,n,s)=>{s.d(n,{Z:()=>t});const t=s.p+"assets/images/rules-3-aff8df5c9338c79f9c64ffbf041f4503.png"},1151:(e,n,s)=>{s.d(n,{Z:()=>l,a:()=>a});var t=s(7294);const r={},i=t.createContext(r);function a(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);