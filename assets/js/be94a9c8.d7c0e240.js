"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[4996],{2808:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"for-ops/cli/deploying","title":"Using the CLI","description":"1. Initialize a values repo","source":"@site/docs/for-ops/cli/deploying.md","sourceDirName":"for-ops/cli","slug":"/for-ops/cli/deploying","permalink":"/docs/for-ops/cli/deploying","draft":false,"unlisted":false,"editUrl":"https://github.com/linode/linode.github.io/tree/main/docs/for-ops/cli/deploying.md","tags":[],"version":"current","frontMatter":{"slug":"deploying","title":"Using the CLI","sidebar_label":"Using the CLI"},"sidebar":"mainSidebar","previous":{"title":"Installation","permalink":"/docs/for-ops/cli/installation"},"next":{"title":"Known issues","permalink":"/docs/for-ops/cli/known-issues"}}');var i=s(4848),t=s(8453);const a={slug:"deploying",title:"Using the CLI",sidebar_label:"Using the CLI"},l=void 0,r={},c=[{value:"1. Initialize a values repo",id:"1-initialize-a-values-repo",level:2},{value:"2. Customize configuration",id:"2-customize-configuration",level:2},{value:"3. Configure credentials from a KMS/Age (optional)",id:"3-configure-credentials-from-a-kmsage-optional",level:2},{value:"4. Start APL Console on your local machine (optional)",id:"4-start-apl-console-on-your-local-machine-optional",level:2},{value:"5. Configuration",id:"5-configuration",level:2},{value:"6. Validation",id:"6-validation",level:2},{value:"7. Deployment",id:"7-deployment",level:2},{value:"Charted vs uncharted resources",id:"charted-vs-uncharted-resources",level:3},{value:"Working with uncharted resources",id:"working-with-uncharted-resources",level:3},{value:"Working with charted resources",id:"working-with-charted-resources",level:3},{value:"Need to know quirks",id:"need-to-know-quirks",level:3},{value:"8. Committing values",id:"8-committing-values",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"1-initialize-a-values-repo",children:"1. Initialize a values repo"}),"\n",(0,i.jsxs)(n.p,{children:["APL needs a git repo to store its configuration. We call it a ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.em,{children:"values"})})," repo."]}),"\n",(0,i.jsxs)(n.p,{children:["In order to quickly get up and running it is advised to download the ",(0,i.jsx)(n.a,{href:"https://github.com/redkubes/otomi-core/blob/main/chart/otomi/values.yaml",children:"chart values"})," and fill in the values."]}),"\n",(0,i.jsx)(n.p,{children:"The following commands bootstrap the values repo:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# map the chart values.yaml as initial input:\nexport VALUES_INPUT=$PWD/values.yaml\n# point to a folder that is or will become the values repo\nexport ENV_DIR=$PWD/otomi-values\n# and bootstrap all the files in there\notomi bootstrap\n"})}),"\n",(0,i.jsx)(n.h2,{id:"2-customize-configuration",children:"2. Customize configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The essential otomi platform configurations is stored in ",(0,i.jsx)(n.code,{children:"env/cluster.yaml"}),", ",(0,i.jsx)(n.code,{children:"env/settings.yaml"})," and ",(0,i.jsx)(n.code,{children:"env/secrets.settings.yaml"})," files. Inspect them and customize values to match your environment."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The minimum required input is found in the ",(0,i.jsx)(n.a,{href:"https://github.com/redkubes/otomi-core/blob/main/chart/otomi/values.yaml",children:"chart values"}),"."]})}),"\n",(0,i.jsx)(n.h2,{id:"3-configure-credentials-from-a-kmsage-optional",children:"3. Configure credentials from a KMS/Age (optional)"}),"\n",(0,i.jsx)(n.admonition,{title:"No encryption needed?",type:"note",children:(0,i.jsx)(n.p,{children:"If you don't need encryption straight away please continue to the next step"})}),"\n",(0,i.jsxs)(n.p,{children:["APL will encrypt any ",(0,i.jsx)(n.code,{children:"secrets.*.yaml"})," files with ",(0,i.jsx)(n.a,{href:"https://github.com/mozilla/sops",children:"sops"}),", but only if it finds ",(0,i.jsx)(n.code,{children:"sops:"})," configuration details. In order to have access to the KMS/Age credentials to encrypt/decrypt, a ",(0,i.jsx)(n.code,{children:".secrets"})," file needs to exist and have those credentials. Please ",(0,i.jsx)(n.code,{children:"copy .secrets.sample .secrets"})," and fill it in with the KMS credentials."]}),"\n",(0,i.jsxs)(n.p,{children:["Then you can run ",(0,i.jsx)(n.code,{children:"otomi bootstrap"}),", which will result in the encryption and decryption of the secrets files."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Note to developers:"})}),"\n",(0,i.jsxs)(n.p,{children:["To allow ",(0,i.jsx)(n.code,{children:"git diff"})," to show unencrypted values, you must register the sops diffing routine once with git. To register it:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git config diff.sopsdiffer.textconv 'sops -d'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This only registers the sops differ, which is responsible for invoking sops. But sops still needs the credentials to the KMS service. Again, your AWS profile is always pointed and loaded, but in case of Google KMS you will need to point GOOGLE_APPLICATION_CREDENTIALS to the ",(0,i.jsx)(n.code,{children:"gcp-key.json"})," file holding your account information:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"export GOOGLE_APPLICATION_CREDENTIALS=$PWD/gcp-key.json\n"})}),"\n",(0,i.jsx)(n.p,{children:"Now try a diff:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git diff\n"})}),"\n",(0,i.jsx)(n.h2,{id:"4-start-apl-console-on-your-local-machine-optional",children:"4. Start APL Console on your local machine (optional)"}),"\n",(0,i.jsx)(n.p,{children:"Bootstrap again and start the console:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"otomi bootstrap\notomi console\n"})}),"\n",(0,i.jsx)(n.p,{children:"The console allows for easy configuration of many settings but not all. Assuming the setup steps are completed, you need to now configure the APL values repository. This repo is the source configuration for APL."}),"\n",(0,i.jsx)(n.h2,{id:"5-configuration",children:"5. Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Configuration can be performed much easier through the APL Console, so please refer to the ",(0,i.jsx)(n.a,{href:"/docs/for-ops/console/overview",children:"APL Console"})," documentation."]}),"\n",(0,i.jsxs)(n.p,{children:["However, chart configuration is not (yet) exposed through the console, so please look at the values repo's ",(0,i.jsx)(n.code,{children:"env/charts/*"})," files to edit the configuration files."]}),"\n",(0,i.jsx)(n.p,{children:"Important things to note:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Every configuration file can have a ",(0,i.jsx)(n.code,{children:"secrets.*.yaml"})," counterpart, but these are optional."]}),"\n",(0,i.jsxs)(n.li,{children:["A json schema and vscode settings are imported by the bootrap (in ",(0,i.jsx)(n.code,{children:".vscode/*"}),"), so you will have automatic linting and hinting for the configuration when vscode is used (try CTRL+SPACE in the yaml)."]}),"\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:".secrets"})," is correctly configured then automatic de-/en-cryption will also be performed when in vscode and editing a ",(0,i.jsx)(n.code,{children:"secrets.*.yaml"})," file."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Please follow the guidance of the yaml hinting, as it has all the descriptions and example values you need to operate on these files."}),"\n",(0,i.jsx)(n.admonition,{title:"APL YAML hinting only works in vscode",type:"info",children:(0,i.jsx)(n.p,{children:"VSCode automatically loads the '.vscode/values-schema.yaml' schema provided. Please inspect it or wire it up manually when using another editor."})}),"\n",(0,i.jsxs)(n.p,{children:["If you wish to be sure of your changes, you can always do a ",(0,i.jsx)(n.code,{children:"git diff"}),". When you chose to use encryption and have correctly followed the corresponding instructions, then you should see a diff with the unencrypted values. That is, if you modified any ;)"]}),"\n",(0,i.jsx)(n.h2,{id:"6-validation",children:"6. Validation"}),"\n",(0,i.jsx)(n.p,{children:"When you are done with the configuration you can validate the results:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"otomi validate-values\n"})}),"\n",(0,i.jsx)(n.p,{children:"If you have made an error in the format of the values this will be reported."}),"\n",(0,i.jsxs)(n.p,{children:["To check if all the output manifests are valid for the target cluster's k8s version, ",(0,i.jsx)(n.em,{children:"and"})," following best practices you can run another variation:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"otomi validate-templates\n"})}),"\n",(0,i.jsx)(n.h2,{id:"7-deployment",children:"7. Deployment"}),"\n",(0,i.jsx)(n.h3,{id:"charted-vs-uncharted-resources",children:"Charted vs uncharted resources"}),"\n",(0,i.jsx)(n.p,{children:"The output manifests generated by otomi are deployed in two ways:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Uncharted: some base manifests are applied directly with ",(0,i.jsx)(n.code,{children:"kubectl apply"})]}),"\n",(0,i.jsx)(n.li,{children:"Charted: manfests that are packaged up in helm charts."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Ideally, we would like to deploy as helm chart as it has ",(0,i.jsx)(n.a,{href:"https://www.google.nl/search?q=benefits+of+helm+chart",children:"many benefits"})," such as rollback. But in some cases we can't or we don't wish to. The reasons for that are the following:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Some resources we don't want governed by charts (as charts might get accidentally removed, erasing everything that was deployed with it)."}),"\n",(0,i.jsx)(n.li,{children:"Some existing resources have to be patched (like pull secrets in service accounts), which helmfile won't do as it will not modify existing resources not annotated to be under control by a chart."}),"\n",(0,i.jsx)(n.li,{children:"Some resources need to exist before the charts are deployed (such as CRDs)."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The manifests that are currently not charted are:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"k8s/base"})," (unparameterized, mostly rbac roles)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"values/cloud"}),' (applies cloud specific "normalization" patterns, such as for storageclasses)']}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"values/k8s"})," (team resources, such as namespaces, service accounts, pull secrets)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"working-with-uncharted-resources",children:"Working with uncharted resources"}),"\n",(0,i.jsx)(n.p,{children:"Currently we don't have any subcommand that only works on uncharted resources, but we have the following commands that target the entire bundle."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"otomi test"}),": does a dry run, showing all manifests that will be deployed, and will also show any errors in the output manifests."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"otomi apply"}),": deploys all the manifests (uncharted first, then charted)"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["So after doing ",(0,i.jsx)(n.code,{children:"otomi test"}),", if all looks ok, go ahead and do the initial deployment of all resources:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"otomi apply\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This command executes two stages (please see ",(0,i.jsx)(n.code,{children:"binzx/apply.ts"}),"). The first stage will deploy all uncharted resources with ",(0,i.jsx)(n.code,{children:"kubectl apply"}),", and the second stage will deploy all the charted resources with ",(0,i.jsx)(n.code,{children:"helmfile apply"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Whenever you add a team, or change or add to these uncharted resources, you have to run ",(0,i.jsx)(n.code,{children:"otomi apply"})," to apply them. When you let Drone do the syncing for you, it will invoke that command to synchronize the cluster."]}),"\n",(0,i.jsx)(n.h3,{id:"working-with-charted-resources",children:"Working with charted resources"}),"\n",(0,i.jsx)(n.p,{children:"During development iterations you will probably not touch uncharted resources often, but instead you will add features in charts."}),"\n",(0,i.jsx)(n.p,{children:"APL has these subcommands that only target charted resources:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"otomi (diff|apply|sync|template)\n"})}),"\n",(0,i.jsx)(n.p,{children:"You can always target a single chart like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"otomi (diff|apply|sync|template) -l name=prometheus-operator\n"})}),"\n",(0,i.jsxs)(n.p,{children:["(For a list of all supported flags to use those subcommands, we defer to the ",(0,i.jsx)(n.a,{href:"https://github.com/roboll/helmfile",children:"helmfile documentation"}),", as those are deferred to the helmfile cli.)"]}),"\n",(0,i.jsx)(n.p,{children:"Let's do a diff of all the charts that are enabled:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"otomi diff\n"})}),"\n",(0,i.jsx)(n.h3,{id:"need-to-know-quirks",children:"Need to know quirks"}),"\n",(0,i.jsxs)(n.p,{children:["Whenever you modify resources without using helm, its internal bookkeeping (the versioned secrets in the namespaces) will not change, and any subsequent ",(0,i.jsx)(n.code,{children:"otomi apply"})," commands will not modify anything. If you notice this, and want to overwrite with the output manifests, you can use ",(0,i.jsx)(n.code,{children:"otomi sync"}),", which will skip doing a diff, and instead apply all charted manifests as a new version."]}),"\n",(0,i.jsx)(n.h2,{id:"8-committing-values",children:"8. Committing values"}),"\n",(0,i.jsx)(n.p,{children:"To commit values and run post processing tasks:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"otomi commit\n"})}),"\n",(0,i.jsxs)(n.p,{children:['This will detect any version changes and then commit all files with a standardized message "Manual commit". (We believe all values repo configuration changes are equally meaningful and don\'t need explicit commit messages.) Directly doing a ',(0,i.jsx)(n.code,{children:"git commit"})," is discouraged with a git hook saying so, but whenever you did not touch any versions in ",(0,i.jsx)(n.code,{children:"env/clusters.yaml"})," you may bypass with ",(0,i.jsx)(n.code,{children:'git commit -m "Manual commit" --no-verify'})," to save development time."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>l});var o=s(6540);const i={},t=o.createContext(i);function a(e){const n=o.useContext(t);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),o.createElement(t.Provider,{value:n},e.children)}}}]);