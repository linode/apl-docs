"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[4584],{8250:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>c,toc:()=>a});var t=n(5893),i=n(1151);const r={slug:"custom-metrics",title:"Using custom metrics",sidebar_label:"Using custom metrics"},o=void 0,c={id:"get-started/labs/custom-metrics",title:"Using custom metrics",description:"For this lab Prometheus and Grafana need to be enabled for the Team.",source:"@site/docs/get-started/labs/custom-metrics.md",sourceDirName:"get-started/labs",slug:"/get-started/labs/custom-metrics",permalink:"/docs/get-started/labs/custom-metrics",draft:!1,unlisted:!1,editUrl:"https://github.com/linode/linode.github.io/tree/main/docs/get-started/labs/custom-metrics.md",tags:[],version:"current",frontMatter:{slug:"custom-metrics",title:"Using custom metrics",sidebar_label:"Using custom metrics"},sidebar:"mainSidebar",previous:{title:"Monitor Workloads",permalink:"/docs/get-started/labs/monitor-workloads"},next:{title:"Create Custom Dashboards",permalink:"/docs/get-started/labs/custom-dashboards"}},l={},a=[{value:"What are custom metrics",id:"what-are-custom-metrics",level:2},{value:"Create a Workload",id:"create-a-workload",level:2},{value:"Check the status of the ServiceMonitor",id:"check-the-status-of-the-servicemonitor",level:2},{value:"See the custom metrics",id:"see-the-custom-metrics",level:2},{value:"Next steps",id:"next-steps",level:2}];function d(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.p,{children:"For this lab Prometheus and Grafana need to be enabled for the Team."})}),"\n",(0,t.jsx)(s.h2,{id:"what-are-custom-metrics",children:"What are custom metrics"}),"\n",(0,t.jsx)(s.p,{children:"Prometheus will collect all kind of standard container metrics like CPU and memory usage, but no (custom) business or customer metrics like the number of customers who logged into your app each hour."}),"\n",(0,t.jsx)(s.p,{children:"To be able to collect custom metrics you will need to expose this data in your code. This is called instrumentation of code and can include annotating the code with metadata, or adding in logic to calculate and expose data."}),"\n",(0,t.jsx)(s.p,{children:"Instrumenting code means you write code to expose information about the technical, business, and customer context. This information can then be collected and analyzed using Prometheus and Grafana."}),"\n",(0,t.jsx)(s.p,{children:"In this lab we will use a container that exposes custom metrics and then show how the metrics can be collected and analysed."}),"\n",(0,t.jsx)(s.h2,{id:"create-a-workload",children:"Create a Workload"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Go to the Catalog and click on the ",(0,t.jsx)(s.code,{children:"k8s-deployment"})," template."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Click on the ",(0,t.jsx)(s.code,{children:"Values"})," tab."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Fill in the name ",(0,t.jsx)(s.code,{children:"custom-metrics"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Use the following values:"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"image:\n  repository: quay.io/rbaumgar/monitor-demo-app-jvm\n  pullPolicy: IfNotPresent\n  tag: latest\ncontainerPorts:\n  - name: web\n    containerPort: 8080\n    protocol: TCP\nservicePorts:\n  - port: 8080\n    targetPort: 8080\n    protocol: TCP\n    name: web\nreplicaCount: 2\nserviceMonitor:\n  create: true\n  endpoints:\n    - interval: 30s\n      port: web\n      scheme: http\n      path: /q/metrics\n"})}),"\n",(0,t.jsxs)(s.ol,{start:"5",children:["\n",(0,t.jsxs)(s.li,{children:["Click ",(0,t.jsx)(s.code,{children:"Submit"})," and then ",(0,t.jsx)(s.code,{children:"Deploy Changes"})]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"check-the-status-of-the-servicemonitor",children:"Check the status of the ServiceMonitor"}),"\n",(0,t.jsx)(s.p,{children:"Check if the ServiveMonitor has been picked up by Prometheus:"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["In the left menu go to ",(0,t.jsx)(s.code,{children:"Apps"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Click on the ",(0,t.jsx)(s.code,{children:"Prometheus"})," app."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["In Prometheus, click on ",(0,t.jsx)(s.code,{children:"Status"})," in the top menu and then click ",(0,t.jsx)(s.code,{children:"Targets"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["You will now see that the ServiceMonitor has the ",(0,t.jsx)(s.code,{children:"State"})," UP:"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"metrics",src:n(2147).Z+"",width:"3348",height:"1342"})}),"\n",(0,t.jsx)(s.p,{children:"Our metrics are now being scraped by the Team's Prometheus. Before we continue, let's first generate some load:"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Go to the ",(0,t.jsx)(s.a,{href:"/docs/get-started/labs/expose-services",children:"Expose services"})," lab and expose the ",(0,t.jsx)(s.code,{children:"custom-metrics"})," service"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Run the following command in your terminal:"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"for i in {1..1000}; do curl https://custom-metrics-labs.<your-domain>/hello; sleep 10; done\n"})}),"\n",(0,t.jsxs)(s.ol,{start:"3",children:["\n",(0,t.jsx)(s.li,{children:"Wait for approximately 10 minutes..."}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"see-the-custom-metrics",children:"See the custom metrics"}),"\n",(0,t.jsx)(s.p,{children:"To see the custom metrics:"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Open the ",(0,t.jsx)(s.code,{children:"Prometheus"})," app."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["In Prometheus, fill in the following Expression: ",(0,t.jsx)(s.code,{children:"application_greetings_total"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Click on ",(0,t.jsx)(s.code,{children:"Graph"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"You should now see the following:"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"metrics",src:n(655).Z+"",width:"3354",height:"1678"})}),"\n",(0,t.jsx)(s.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,t.jsx)(s.p,{children:"Prometheus is now scraping our custom metrics. You can now use these metrics to:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Create a dashboard in Grafana in the lab ",(0,t.jsx)(s.a,{href:"/docs/get-started/labs/custom-dashboards",children:"Create custom dashboards"})]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["Create rules and send alerts in the lab ",(0,t.jsx)(s.a,{href:"/docs/get-started/labs/custom-rules",children:"Create custom rules"})]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,i.a)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},655:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/custom-metrics-1-9fa964600b6dbb303c5e18d19204ebf9.png"},2147:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/custom-metrics-84c2d188b5fafed0cacccf7aae94c599.png"},1151:(e,s,n)=>{n.d(s,{Z:()=>c,a:()=>o});var t=n(7294);const i={},r=t.createContext(i);function o(e){const s=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:s},e.children)}}}]);