"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[3344],{6219:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"get-started/labs/create-netpols","title":"Configuring network policies","description":"In this lab you\u2019ll explicitly open only the network paths your app needs using two dedicated UIs:","source":"@site/docs/get-started/labs/create-netpols.md","sourceDirName":"get-started/labs","slug":"/get-started/labs/create-netpols","permalink":"/docs/get-started/labs/create-netpols","draft":false,"unlisted":false,"editUrl":"https://github.com/linode/linode.github.io/tree/main/docs/get-started/labs/create-netpols.md","tags":[],"version":"current","frontMatter":{"slug":"create-netpols","title":"Configuring network policies","sidebar_label":"Create Network Policies"},"sidebar":"mainSidebar","previous":{"title":"Using custom metrics","permalink":"/docs/get-started/labs/custom-metrics"},"next":{"title":"Use OpenTelemery","permalink":"/docs/get-started/labs/use-otel"}}');var l=s(4848),i=s(8453);const o={slug:"create-netpols",title:"Configuring network policies",sidebar_label:"Create Network Policies"},t=void 0,d={},a=[{value:"Understanding Inbound Rules",id:"understanding-inbound-rules",level:2},{value:"Understanding Outbound Rules",id:"understanding-outbound-rules",level:2},{value:"Lab Part\xa01: Deploy the Voting App",id:"lab-part1-deploy-the-voting-app",level:2},{value:"1. Build container images",id:"1-build-container-images",level:3},{value:"2. Deploy Redis &amp; Postgres",id:"2-deploy-redis--postgres",level:3},{value:"3. Deploy your workloads",id:"3-deploy-your-workloads",level:3},{value:"Vote app",id:"vote-app",level:4},{value:"Worker app",id:"worker-app",level:4},{value:"Result app",id:"result-app",level:4},{value:"4. Expose your services",id:"4-expose-your-services",level:3},{value:"Lab Part\xa02: Ingress Rules for Voting App",id:"lab-part2-ingress-rules-for-voting-app",level:2},{value:"Postgres Ingress",id:"postgres-ingress",level:3},{value:"Redis Ingress",id:"redis-ingress",level:3},{value:"Lab Part\xa03: Egress Rule for Troubleshooting",id:"lab-part3-egress-rule-for-troubleshooting",level:2},{value:"Create example.com Egress",id:"create-examplecom-egress",level:3},{value:"Lab Part\xa04: Testing",id:"lab-part4-testing",level:2},{value:"Verify pod\u2011to\u2011pod (Ingress)",id:"verify-podtopod-ingress",level:3},{value:"Verify external (Egress)",id:"verify-external-egress",level:3}];function c(e){const n={admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"In this lab you\u2019ll explicitly open only the network paths your app needs using two dedicated UIs:"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Inbound Rules"})," \u2014 pod\u2011to\u2011pod (cluster\u2011internal)"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Outbound Rules"})," \u2014 external (egress to FQDNs/IPs)"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["When ",(0,l.jsx)(n.strong,{children:"Ingress control"})," is enabled for your team, ",(0,l.jsx)(n.em,{children:"all"})," pod\u2011to\u2011pod traffic is denied by default. When ",(0,l.jsx)(n.strong,{children:"Egress control"})," is enabled, ",(0,l.jsx)(n.em,{children:"all"})," external traffic is denied by default. You\u2019ll create only the rules required by your Voting App."]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"understanding-inbound-rules",children:"Understanding Inbound Rules"}),"\n",(0,l.jsx)(n.p,{children:"Inbound Rules let you:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Keep pods locked down (deny\u2011all by default)"}),"\n",(0,l.jsx)(n.li,{children:"Allow specific workloads (via workload dropdown + auto\u2011fetched labels) to connect to your pods"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"understanding-outbound-rules",children:"Understanding Outbound Rules"}),"\n",(0,l.jsx)(n.p,{children:"Outbound Rules let you:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Keep pods locked down from external traffic (deny\u2011all by default)"}),"\n",(0,l.jsx)(n.li,{children:"Allow namespace\u2011wide access to specific FQDNs or IPs"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"lab-part1-deploy-the-voting-app",children:"Lab Part\xa01: Deploy the Voting App"}),"\n",(0,l.jsx)(n.h3,{id:"1-build-container-images",children:"1. Build container images"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Register a Code Repository with ",(0,l.jsx)(n.code,{children:"https://github.com/linode/apl-examples"})," as the URL."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Create three Docker Container Images. For the Dockerfile path you can use:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"vote"})," \u2192 ",(0,l.jsx)(n.code,{children:"vote-app/vote/Dockerfile"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"worker"})," \u2192 ",(0,l.jsx)(n.code,{children:"vote-app/worker/Dockerfile"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"result"})," \u2192 ",(0,l.jsx)(n.code,{children:"vote-app/result/Dockerfile"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"2-deploy-redis--postgres",children:"2. Deploy Redis & Postgres"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["In the Catalog, install ",(0,l.jsx)(n.strong,{children:"redis"})," (redis-ha) with default settings."]}),"\n",(0,l.jsxs)(n.li,{children:["Install ",(0,l.jsx)(n.strong,{children:"postgresql"})," (postgresql-cluster) with default settings."]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"3-deploy-your-workloads",children:"3. Deploy your workloads"}),"\n",(0,l.jsx)(n.h4,{id:"vote-app",children:"Vote app"}),"\n",(0,l.jsxs)(n.p,{children:["Use the ",(0,l.jsx)(n.code,{children:"k8s-deployment"})," chart:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"image:\n  repository: harbor.<your-domain>/team-<team-name>/vote\n  pullPolicy: IfNotPresent\n  tag: main\ncontainerPorts:\n  - name: http\n    containerPort: 80\n    protocol: TCP\nenv:\n  - name: REDIS_HOST\n    value: <redis-ha-name>\nreplicaCount: 1\n"})}),"\n",(0,l.jsx)(n.h4,{id:"worker-app",children:"Worker app"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"image:\n  repository: harbor.<your-domain>/team-<team-name>/worker\n  pullPolicy: IfNotPresent\n  tag: main\ncontainerPorts:\n  - name: http\n    containerPort: 80\n    protocol: TCP\nenv:\n  - name: DATABASE_USER\n    valueFrom:\n      secretKeyRef:\n        name: <psql-cluster-name>-app\n        key: username\n  - name: DATABASE_PASSWORD\n    valueFrom:\n      secretKeyRef:\n        name: <psql-cluster-name>-app\n        key: password\n  - name: REDIS_HOST\n    value: <redis-ha-name>\n  - name: DATABASE_HOST\n    value: <psql-cluster-name>-rw\nreplicaCount: 1\n"})}),"\n",(0,l.jsx)(n.admonition,{type:"note",children:(0,l.jsx)(n.p,{children:"The worker pod will show an error \u201cWaiting for db\u201d in the logs. This is an expected error that will be resolved when all the steps in the lab are done."})}),"\n",(0,l.jsx)(n.h4,{id:"result-app",children:"Result app"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"image:\n  repository: harbor.<your-domain>/team-<team-name>/result\n  pullPolicy: IfNotPresent\n  tag: main\ncontainerPorts:\n  - name: http\n    containerPort: 80\n    protocol: TCP\nenv:\n  - name: DATABASE_USER\n    valueFrom:\n      secretKeyRef:\n        name: <psql-cluster-name>-app\n        key: username\n  - name: DATABASE_PASSWORD\n    valueFrom:\n      secretKeyRef:\n        name: <psql-cluster-name>-app\n        key: password\n  - name: DATABASE_HOST\n    value: <psql-cluster-name>-rw\n  - name: DATABASE_NAME\n    value: <psql-cluster-name>\nreplicaCount: 1\n"})}),"\n",(0,l.jsx)(n.admonition,{type:"note",children:(0,l.jsx)(n.p,{children:"The result pod will show an error \u201cWaiting for db\u201d in the logs. This is an expected error that will be resolved when all the steps in the lab are done."})}),"\n",(0,l.jsx)(n.h3,{id:"4-expose-your-services",children:"4. Expose your services"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Create a service for ",(0,l.jsx)(n.code,{children:"vote"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["Create a service for ",(0,l.jsx)(n.code,{children:"result"}),"."]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"lab-part2-ingress-rules-for-voting-app",children:"Lab Part\xa02: Ingress Rules for Voting App"}),"\n",(0,l.jsx)(n.p,{children:"You\u2019ll allow only Worker & Result to reach Postgres, and only Vote & Worker to reach Redis."}),"\n",(0,l.jsx)(n.h3,{id:"postgres-ingress",children:"Postgres Ingress"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Navigate:"})," ",(0,l.jsx)(n.strong,{children:"Network Policies\u202f>\u202fInbound Rules"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"CREATE INBOUND RULE"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Name:"})," ",(0,l.jsx)(n.code,{children:"postgres-ingress"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Sources:"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Workload:"})," select ",(0,l.jsx)(n.strong,{children:"worker"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Label(s):"})," Select ",(0,l.jsx)(n.code,{children:"otomi.io/app=worker"}),"from the drop-down"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Click ",(0,l.jsx)(n.strong,{children:"ADD SOURCE"}),", then add:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Workload:"})," result"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Label(s):"})," ",(0,l.jsx)(n.code,{children:"otomi.io/app=result"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Target:"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Workload:"})," postgres"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Label:"})," ",(0,l.jsx)(n.code,{children:"otomi.io/app=postgres"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Save Changes"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"redis-ingress",children:"Redis Ingress"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"CREATE INBOUND RULE"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Name:"})," ",(0,l.jsx)(n.code,{children:"redis-ingress"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Sources:"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Workload:"})," select ",(0,l.jsx)(n.strong,{children:"worker"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Label(s):"})," Select ",(0,l.jsx)(n.code,{children:"otomi.io/app=worker"}),"from the drop-down"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Click ",(0,l.jsx)(n.strong,{children:"ADD SOURCE"}),", then add:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Workload:"})," vote"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Label(s):"})," ",(0,l.jsx)(n.code,{children:"otomi.io/app=vote"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Target:"})," Redis \u2192 ",(0,l.jsx)(n.code,{children:"otomi.io/app=redis"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Save Changes"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"lab-part3-egress-rule-for-troubleshooting",children:"Lab Part\xa03: Egress Rule for Troubleshooting"}),"\n",(0,l.jsxs)(n.p,{children:["You\u2019ll allow HTTPS egress to ",(0,l.jsx)(n.code,{children:"example.com"})," so you can test connectivity."]}),"\n",(0,l.jsx)(n.h3,{id:"create-examplecom-egress",children:"Create example.com Egress"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Navigate:"})," ",(0,l.jsx)(n.strong,{children:"Network Policies\u202f>\u202fOutbound Rules"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"CREATE OUTBOUND RULE"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Name:"})," ",(0,l.jsx)(n.code,{children:"example-egress"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Domain name or IP address:"})," ",(0,l.jsx)(n.code,{children:"example.com"})]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Protocol & Port:"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Protocol: ",(0,l.jsx)(n.strong,{children:"HTTPS"})]}),"\n",(0,l.jsxs)(n.li,{children:["Port: ",(0,l.jsx)(n.strong,{children:"443"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Save Changes"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"lab-part4-testing",children:"Lab Part\xa04: Testing"}),"\n",(0,l.jsx)(n.h3,{id:"verify-podtopod-ingress",children:"Verify pod\u2011to\u2011pod (Ingress)"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["Browse to your ",(0,l.jsx)(n.strong,{children:"Vote"})," service\u2019s external URL \u2192 cast a vote."]}),"\n",(0,l.jsxs)(n.li,{children:["Browse to your ",(0,l.jsx)(n.strong,{children:"Result"})," service\u2019s URL \u2192 confirm the vote appears."]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"verify-external-egress",children:"Verify external (Egress)"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Launch Netshoot in your team namespace:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"kubectl run -i --tty --rm netshoot \\\n  --image nicolaka/netshoot -n team-labs\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Inside the pod, run:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:" curl -s https://example.com | grep -o '<h1.*</h1>'\n"})}),"\n",(0,l.jsx)(n.p,{children:"You should see:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"<h1>Example Domain</h1>\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Exit the pod (",(0,l.jsx)(n.code,{children:"exit"}),"). It will be removed automatically."]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.p,{children:"Congratulations\u2014your Voting App is now locked down to exactly the paths you opened!"})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>t});var r=s(6540);const l={},i=r.createContext(l);function o(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);