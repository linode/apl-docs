"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[8560],{6123:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"for-ops/upgrade-notes","title":"Upgrade Notes","description":"About upgrade notes","source":"@site/docs/for-ops/upgrade-notes.md","sourceDirName":"for-ops","slug":"/for-ops/upgrade-notes","permalink":"/docs/for-ops/upgrade-notes","draft":false,"unlisted":false,"editUrl":"https://github.com/linode/linode.github.io/tree/main/docs/for-ops/upgrade-notes.md","tags":[],"version":"current","frontMatter":{"slug":"upgrade-notes","title":"Upgrade Notes","sidebar_label":"Upgrade Notes"},"sidebar":"mainSidebar","previous":{"title":"Upgrade Instructions","permalink":"/docs/for-ops/upgrade-instructions"},"next":{"title":"Known Issues","permalink":"/docs/for-ops/known-issues"}}');var a=n(4848),t=n(8453);const s={slug:"upgrade-notes",title:"Upgrade Notes",sidebar_label:"Upgrade Notes"},i=void 0,l={},d=[{value:"About upgrade notes",id:"about-upgrade-notes",level:2},{value:"v4.7.0",id:"v470",level:2},{value:"Manual Istio Sidecar Updates Required",id:"manual-istio-sidecar-updates-required",level:3},{value:"Affected Pod Types",id:"affected-pod-types",level:4},{value:"Manual Restart Procedures",id:"manual-restart-procedures",level:4},{value:"Verification",id:"verification",level:4},{value:"v4.4.4 to v4.7.0 or higher",id:"v444-to-v470-or-higher",level:2},{value:"Ensuring no stale pipelines run",id:"ensuring-no-stale-pipelines-run",level:3},{value:"Fixing the Redis instance of Harbor",id:"fixing-the-redis-instance-of-harbor",level:3},{value:"Disable ArgoCD autoSync on harbor-harbor",id:"disable-argocd-autosync-on-harbor-harbor",level:4},{value:"Scale down harbor-jobservice, harbor-core to zero",id:"scale-down-harbor-jobservice-harbor-core-to-zero",level:4},{value:"Scale down harbor-redis to zero",id:"scale-down-harbor-redis-to-zero",level:4},{value:"PVC data-harbor-redis-0 is deleted",id:"pvc-data-harbor-redis-0-is-deleted",level:4},{value:"Scale up harbor-redis to one",id:"scale-up-harbor-redis-to-one",level:4},{value:"Wait for pod ready status",id:"wait-for-pod-ready-status",level:4},{value:"Enable ArgoCD autoSync on harbor-harbor",id:"enable-argocd-autosync-on-harbor-harbor",level:4}];function c(e){const r={admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(r.h2,{id:"about-upgrade-notes",children:"About upgrade notes"}),"\n",(0,a.jsx)(r.p,{children:"In some cases between versions upgrades there are issues that can occur. This page describes known potential issues and their mitigations."}),"\n",(0,a.jsx)(r.h2,{id:"v470",children:"v4.7.0"}),"\n",(0,a.jsx)(r.h3,{id:"manual-istio-sidecar-updates-required",children:"Manual Istio Sidecar Updates Required"}),"\n",(0,a.jsx)(r.p,{children:"Due to an issue with automatic Istio sidecar restarts for certain pod types, manual intervention is required after upgrading Istio to ensure all pods have the latest sidecar version."}),"\n",(0,a.jsx)(r.h4,{id:"affected-pod-types",children:"Affected Pod Types"}),"\n",(0,a.jsx)(r.p,{children:"The following pod types require manual restart after Istio upgrades:"}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsx)(r.li,{children:"TTY pods (standalone pods without controllers)"}),"\n",(0,a.jsx)(r.li,{children:"Tekton EventListener pods (managed by Tekton controllers)"}),"\n"]}),"\n",(0,a.jsx)(r.h4,{id:"manual-restart-procedures",children:"Manual Restart Procedures"}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.strong,{children:"For TTY Pods:"})}),"\n",(0,a.jsx)(r.p,{children:"TTY pods are standalone and will not be recreated automatically when deleted. Handle with care:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# Delete all TTY pods (WARNING: This will terminate TTY sessions for any connected users)\nkubectl delete pods -A -l otomi=tty\n"})}),"\n",(0,a.jsx)(r.admonition,{type:"warning",children:(0,a.jsx)(r.p,{children:"Deleting TTY pods will disconnect any active user sessions and the pods will NOT be recreated automatically. Users will need to create a new TTY session through the UI. Coordinate with users before performing this action."})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.strong,{children:"For Tekton EventListener Pods:"})}),"\n",(0,a.jsx)(r.p,{children:"EventListener pods will be automatically recreated by the Tekton controller:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# Delete all EventListener pods (safe - will be recreated automatically)\nkubectl delete pods -A -l app.kubernetes.io/managed-by=EventListener\n"})}),"\n",(0,a.jsx)(r.admonition,{type:"note",children:(0,a.jsx)(r.p,{children:"The Tekton controller will automatically recreate the pod with the new Istio sidecar."})}),"\n",(0,a.jsx)(r.h4,{id:"verification",children:"Verification"}),"\n",(0,a.jsx)(r.p,{children:"After restarting pods, verify they have the correct Istio sidecar version:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'# Get the current Istio version for comparison\necho "=== Current Istio Version ==="\nkubectl get deployment -n istio-system -l app=istiod -o jsonpath=\'{.items[0].spec.template.spec.containers[0].image}\' | cut -d: -f2\n\necho ""\necho "=== TTY Pods Sidecar Versions ==="\nkubectl get pods -A -l otomi=tty -o jsonpath=\'{range .items[*]}{.metadata.namespace}{"\\t"}{.metadata.name}{"\\t"}{.spec.containers[?(@.image contains "istio/proxyv2")].image}{"\\n"}{end}\' | column -t\n\necho ""\necho "=== EventListener Pods Sidecar Versions ==="\nkubectl get pods -A -l app.kubernetes.io/managed-by=EventListener -o jsonpath=\'{range .items[*]}{.metadata.namespace}{"\\t"}{.metadata.name}{"\\t"}{.spec.containers[?(@.image contains "istio/proxyv2")].image}{"\\n"}{end}\' | column -t\n'})}),"\n",(0,a.jsx)(r.h2,{id:"v444-to-v470-or-higher",children:"v4.4.4 to v4.7.0 or higher"}),"\n",(0,a.jsxs)(r.p,{children:["Prior to the platform upgrade, a Gitea upgrade requires that no stale pipelines are running and attempting to apply changes to the cluster.\nThere might occur an issue with the Redis instance of Harbor, which results in the ",(0,a.jsx)(r.code,{children:"harbor-redis-0"})," pod restarting indefinitely after the upgrade."]}),"\n",(0,a.jsx)(r.h3,{id:"ensuring-no-stale-pipelines-run",children:"Ensuring no stale pipelines run"}),"\n",(0,a.jsx)(r.p,{children:'First of all, ensure no other platform users are currently applying changes to the cluster. Before upgrading, go to Apps -> Tekton and select "PipelineRuns" on the left, and "otomi-pipelines" on the top-right dropdown. Ensure that no pipelines are running: Their status must be either Succeeded, Failed, or Canceled. If any of them are in state Pending or Running, open the menu next to them, and select "Stop".'}),"\n",(0,a.jsx)(r.p,{children:"As soon as the upgrade is started, it will create a PipelineRun. This one will be automatically terminated, and as of v4.7.0 Tekton is no longer used for applying platform changes."}),"\n",(0,a.jsx)(r.h3,{id:"fixing-the-redis-instance-of-harbor",children:"Fixing the Redis instance of Harbor"}),"\n",(0,a.jsx)(r.p,{children:"To solve this issue you have to delete the Harbor Redis data according to the following steps."}),"\n",(0,a.jsx)(r.h4,{id:"disable-argocd-autosync-on-harbor-harbor",children:"Disable ArgoCD autoSync on harbor-harbor"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'kubectl patch application harbor-harbor \\\n  -n argocd \\\n  --type=\'json\' \\\n  -p=\'[{"op": "remove", "path": "/spec/syncPolicy/automated"}]\'\n'})}),"\n",(0,a.jsx)(r.h4,{id:"scale-down-harbor-jobservice-harbor-core-to-zero",children:"Scale down harbor-jobservice, harbor-core to zero"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"kubectl scale deploy harbor-jobservice --replicas=0 -n harbor\nkubectl scale deploy harbor-core --replicas=0 -n harbor\n"})}),"\n",(0,a.jsx)(r.admonition,{type:"note",children:(0,a.jsx)(r.p,{children:"If the version you are going to upgrade to is of v4.7.0 or higher you also have to scale down the apl-operator"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"kubectl scale deploy apl-operator --replicas=0 -n apl-operator\n"})}),"\n",(0,a.jsx)(r.h4,{id:"scale-down-harbor-redis-to-zero",children:"Scale down harbor-redis to zero"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"kubectl scale sts harbor-redis --replicas=0 -n harbor\n"})}),"\n",(0,a.jsx)(r.h4,{id:"pvc-data-harbor-redis-0-is-deleted",children:"PVC data-harbor-redis-0 is deleted"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"kubectl delete pvc data-harbor-redis-0 -n harbor\n"})}),"\n",(0,a.jsx)(r.h4,{id:"scale-up-harbor-redis-to-one",children:"Scale up harbor-redis to one"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"kubectl scale sts harbor-redis --replicas=1 -n harbor\n"})}),"\n",(0,a.jsx)(r.h4,{id:"wait-for-pod-ready-status",children:"Wait for pod ready status"}),"\n",(0,a.jsx)(r.admonition,{type:"note",children:(0,a.jsx)(r.p,{children:"If the version you are going to upgrade to is of v4.7.0 or higher you also have to scale up the apl-operator"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"kubectl scale deploy apl-operator --replicas=1 -n apl-operator\n"})}),"\n",(0,a.jsx)(r.h4,{id:"enable-argocd-autosync-on-harbor-harbor",children:"Enable ArgoCD autoSync on harbor-harbor"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'kubectl patch application harbor-harbor \\\n  -n argocd \\\n  --type=\'json\' \\\n  -p=\'[{"op": "add", "path": "/spec/syncPolicy/automated", "value": {"prune": true,"selfHeal": true}}]\'\n'})})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>s,x:()=>i});var o=n(6540);const a={},t=o.createContext(a);function s(e){const r=o.useContext(t);return o.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function i(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),o.createElement(t.Provider,{value:r},e.children)}}}]);