"use strict";(self.webpackChunkredkubes_github_io=self.webpackChunkredkubes_github_io||[]).push([[6693],{6216:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"for-ops/disaster-recovery/platform-reinstall","title":"Reinstalling the platform","description":"Prerequisites","source":"@site/docs/for-ops/disaster-recovery/platform-reinstall.md","sourceDirName":"for-ops/disaster-recovery","slug":"/for-ops/disaster-recovery/reinstall","permalink":"/docs/for-ops/disaster-recovery/reinstall","draft":false,"unlisted":false,"editUrl":"https://github.com/linode/linode.github.io/tree/main/docs/for-ops/disaster-recovery/platform-reinstall.md","tags":[],"version":"current","frontMatter":{"slug":"reinstall","title":"Reinstalling the platform","sidebar_label":"Reinstall"},"sidebar":"mainSidebar","previous":{"title":"Databases","permalink":"/docs/for-ops/disaster-recovery/databases"},"next":{"title":"Overview","permalink":"/docs/for-ops/sre/overview"}}');var r=s(4848),a=s(8453);const i={slug:"reinstall",title:"Reinstalling the platform",sidebar_label:"Reinstall"},l=void 0,o={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Steps",id:"steps",level:2},{value:"Provision a new cluster",id:"provision-a-new-cluster",level:2},{value:"Values file adjustments",id:"values-file-adjustments",level:2},{value:"Stopping write operations",id:"stopping-write-operations",level:2},{value:"Re-installing the platform",id:"re-installing-the-platform",level:2},{value:"Restoring Gitea repositories",id:"restoring-gitea-repositories",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"All the required backups exist in object storage, and the storage has not been corrupted."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"You should have downloaded a (non-redacted) values file using Platform -> Maintenance."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"You should have your own domain name for the cluster. The old and the reinstalled cluster may use the same domain, but in that case the old cluster should no longer be running. For avoiding issues with DNS caching it is advised to use a new (sub-)domain."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Re-installing a Linode LKE cluster with the App Platform for LKE is currently not supported. It can only be installed in a new LKE cluster without the pre-installed platform, using your own domain."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Gitea cannot be restored directly onto a new installation of App Platform. The data and a database backup can however be restored after the installation with an initial database."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"steps",children:"Steps"}),"\n",(0,r.jsx)(n.p,{children:"The following steps are described in more detail:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Pepare a new cluster."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Prepare the values for for reinstallation."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Make sure to stop any write operations to object storage."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Reinstall the platform on the new cluster."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Restore the Gitea database and repositories."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"provision-a-new-cluster",children:"Provision a new cluster"}),"\n",(0,r.jsx)(n.p,{children:"Provide a new cluster suitable for running the configuration. Do not install the platform directly when creating an LKE cluster. Example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'# Update variables as needed\nCLUSTER_LABEL=new-cluster\nCLUSTER_REGION=nl-ams\n\n# Create the new cluster\nlinode-cli lke cluster-create \\\n  --label "$CLUSTER_LABEL" \\\n  --region "$CLUSTER_REGION" \\\n  --k8s_version 1.31 \\\n  --control_plane.high_availability true \\\n  --node_pools.type g6-dedicated-8 \\\n  --node_pools.count 3\n# Retrieve the kubeconfig\nlinode-cli get-kubeconfig --label "$CLUSTER_LABEL"\n# Set cluster id variable\nCLUSTER_ID=$(linode-cli lke clusters-list --label "$CLUSTER_LABEL" --json  | jq ".[0].id")\n# Set new default context\nkubectl config use-context lke$CLUSTER_ID-ctx\n'})}),"\n",(0,r.jsx)(n.h2,{id:"values-file-adjustments",children:"Values file adjustments"}),"\n",(0,r.jsx)(n.p,{children:"Make a copy of the downloaded values file and adjust:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"cluster.domainSuffix"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"dns.domainFilters"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/get-started/installation/dns",children:"DNS configuration"})," must be updated, if the previous platform was provisioned directly through Linode API"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cluster.name"})," (preferably to the label of the new cluster from the previous step)"]}),"\n",(0,r.jsx)(n.li,{children:"Other credentials (e.g. access tokens) that will change"}),"\n",(0,r.jsx)(n.li,{children:"Domains of any services that are changed"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["First relocate the new cluster's backups, provided they are using the same object storage (buckets), by updating the ",(0,r.jsx)(n.code,{children:"pathSuffix"}),". The backups can be activated except for Gitea, which should only be activated after the recovery (in the last step)."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# ...\nplatformBackups:\n  database:\n    gitea:\n      # To be activated later\n      enabled: false\n      retentionPolicy: 7d\n      schedule: 0 0 * * *\n      pathSuffix: gitea-1\n    harbor:\n      enabled: true\n      retentionPolicy: 7d\n      schedule: 0 0 * * *\n      pathSuffix: harbor-1\n    keycloak:\n      enabled: true\n      retentionPolicy: 7d\n      schedule: 0 0 * * *\n      pathSuffix: keycloak-1\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Then prepare the database to be initialized with the backup data from the attached object storage.\nIn the following examples, replace the ",(0,r.jsx)(n.code,{children:"<bucket-name>"})," and ",(0,r.jsx)(n.code,{children:"<storage-region>"})," placeholders. If the source platform itself has been recovered from a backup before, also update the last portion of the ",(0,r.jsx)(n.code,{children:"destinationPath"}),", e.g. to ",(0,r.jsx)(n.code,{children:"harbor-1"}),". In that case, change the aforementioned ",(0,r.jsx)(n.code,{children:"pathSuffix"})," to a different value, e.g. ",(0,r.jsx)(n.code,{children:"harbor-2"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["In the section ",(0,r.jsx)(n.code,{children:"databases.harbor"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# ...\ndatabases:\n  # ...\n  harbor:\n    # ...\n    recovery:\n      source: harbor-backup\n      database: registry\n      owner: harbor\n    externalClusters:\n      - name: harbor-backup\n        barmanObjectStore:\n          serverName: harbor-otomi-db\n          destinationPath: s3://<bucket-name>/harbor\n          endpointURL: https://<storage-region>.linodeobjects.com\n          s3Credentials:\n            accessKeyId:\n              name: linode-creds\n              key: S3_STORAGE_ACCOUNT\n            secretAccessKey:\n              name: linode-creds\n              key: S3_STORAGE_KEY\n          wal:\n            compression: gzip\n            maxParallel: 8\n          data:\n            compression: gzip\n"})}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"databases.keycloak"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# ...\ndatabases:\n  # ...\n  keycloak:\n    # ...\n    recovery:\n      source: keycloak-backup\n      database: keycloak\n      owner: keycloak\n    externalClusters:\n      - name: keycloak-backup\n        barmanObjectStore:\n          serverName: keycloak-db\n          destinationPath: s3://<bucket-name>/keycloak\n          endpointURL: https://<storage-region>.linodeobjects.com\n          s3Credentials:\n            accessKeyId:\n              name: linode-creds\n              key: S3_STORAGE_ACCOUNT\n            secretAccessKey:\n              name: linode-creds\n              key: S3_STORAGE_KEY\n          wal:\n            compression: gzip\n            maxParallel: 8\n          data:\n            compression: gzip\n"})}),"\n",(0,r.jsx)(n.h2,{id:"stopping-write-operations",children:"Stopping write operations"}),"\n",(0,r.jsx)(n.p,{children:"If the old cluster is still running, make sure to halt any write operations to the object storage that the new one will be using for recovery. While for your applications this is very individual, for the platform this means in detail:"}),"\n",(0,r.jsxs)(n.p,{children:["Where applicable, on the Console of ",(0,r.jsx)(n.strong,{children:"the old cluster"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Go to Settings -> Backup, and disable all options. Also clear the ",(0,r.jsx)(n.code,{children:"linodeApiToken"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Go to Settings -> Object storage, and set the provider to ",(0,r.jsx)(n.code,{children:"Disabled"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Note that apps strictly dependent on object storage (e.g. Harbor) will become unavailable on the old cluster."}),"\n",(0,r.jsx)(n.h2,{id:"re-installing-the-platform",children:"Re-installing the platform"}),"\n",(0,r.jsxs)(n.p,{children:["Follow the basic ",(0,r.jsx)(n.a,{href:"/docs/get-started/installation/helm",children:"installation instructions"})," to install the Helm repository. Then install the platform using the edited values file:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"helm install -f updated-values.yaml apl apl/apl\n"})}),"\n",(0,r.jsx)(n.p,{children:"Note that due to some race conditions during the Helm execution, some recoverable errors may occur during the installation process. Currently known issues are:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The database recovery pods (suffixed with ",(0,r.jsx)(n.code,{children:"-full-recovery"}),") may fail to start, reporting a missing secret. This can usually be fixed by deleting the pod. It will be recreated automatically."]}),"\n",(0,r.jsx)(n.li,{children:"The Istio operator can sometimes take a long time  to start."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"When the installation has completed, you should be able to log into the console using the credentials known from the previous platform."}),"\n",(0,r.jsx)(n.h2,{id:"restoring-gitea-repositories",children:"Restoring Gitea repositories"}),"\n",(0,r.jsxs)(n.p,{children:["When the platform is installed, Gitea can also be restored to the state as preserved in the backups. For restoring the database, refer to the ",(0,r.jsx)(n.a,{href:"/docs/for-ops/disaster-recovery/databases",children:"instructions on platform databases"}),"."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"/docs/for-ops/disaster-recovery/databases#regular-recovery-with-backup-in-same-cluster",children:"Adjust the values file in the repository"})," taking into account the ",(0,r.jsx)(n.a,{href:"/docs/for-ops/disaster-recovery/databases#obtaining-a-backup-outside-the-cluster",children:"cluster is restored from a remote backup"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"/docs/for-ops/disaster-recovery/databases#shutting-down-services",children:"Shut down Gitea"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Delete the Gitea database."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"/docs/for-ops/disaster-recovery/databases#restarting-services",children:"Start Gitea"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Activate backups for Gitea in the platform Settings -> Backups."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The contents of the code repositories can be retrieved following the ",(0,r.jsx)(n.a,{href:"/docs/for-ops/disaster-recovery/gitea",children:"Gitea-specific steps"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>l});var t=s(6540);const r={},a=t.createContext(r);function i(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);